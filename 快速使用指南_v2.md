# 太极拳起势动作评估系统 v2.0 - 快速使用指南

## 🚀 快速开始

### 方式1: 一键测试（推荐）

```bash
python test_improved_system.py
```

这将自动测试三个视频（qishi1.mp4, qishi2.mp4, qishi3.mp4）并显示评估结果。

### 方式2: 评估指定视频

```bash
python test_improved_system.py -v video/your_video.mp4
```

---

## 📋 系统要求

- Python 3.7+
- TensorFlow 2.x
- MediaPipe
- OpenCV
- NumPy
- scikit-learn
- joblib

### 安装依赖

```bash
pip install -r requirements.txt
```

---

## 🎬 使用示例

### 示例1: 评估单个视频

```python
from test_improved_system import evaluate_video

# 评估视频
result = evaluate_video("video/qishi1.mp4", n_frames=12)

# 查看结果
print(f"分数: {result['score']*100:.2f}%")
print(f"是否标准: {result['is_correct']}")
print(f"建议: {result['advice']}")
```

**输出示例**:
```
质量分数: 0.00%
动作判定: [!] 需改进
改进建议: 屈膝不足，请下沉重心，膝盖微屈。 手臂偏高，请下放手臂保持与肩平行。
```

### 示例2: 批量评估

```python
import os

video_dir = "video"
for filename in os.listdir(video_dir):
    if filename.endswith(".mp4"):
        video_path = os.path.join(video_dir, filename)
        result = evaluate_video(video_path, n_frames=12)
        
        print(f"{filename}: {result['score']*100:.2f}% - {result['advice']}")
```

---

## 🔧 自定义训练

### 使用自己的标准视频重新训练

#### 步骤1: 提取标准特征

编辑 `extract_standard_features.py`，修改视频路径：

```python
video_path = "video/your_standard_video.mp4"
```

运行：
```bash
python extract_standard_features.py
```

#### 步骤2: 生成训练数据

```bash
python taichi_ai/generate_data_v2.py
```

参数可调整:
- `n_correct`: 正确样本数量（默认800）
- `n_wrong`: 错误样本数量（默认800）

#### 步骤3: 训练模型

```bash
python taichi_ai/train_model_v2.py
```

训练完成后会生成：
- `taichi_mlp_v2.h5` - 训练好的模型
- `scaler.pkl` - 数据标准化器
- `model_evaluation_report_v2.png` - 训练报告

#### 步骤4: 测试新模型

```bash
python test_improved_system.py -v video/test_video.mp4
```

---

## 📊 输出说明

### 评估分数含义

| 分数范围 | 判定 | 说明 |
|---------|------|------|
| 90-100% | 优秀 | 动作非常标准 |
| 70-89% | 良好 | 动作基本标准 |
| 50-69% | 及格 | 动作有明显偏差 |
| 0-49% | 不及格 | 动作错误较多 |

### 建议类型

系统会检测以下8种错误类型：

1. **shoulder_high** - 肩膀不平
2. **knee_not_bent** - 屈膝不足
3. **arm_too_low** - 手臂偏低
4. **arm_too_high** - 手臂偏高
5. **torso_lean** - 躯干倾斜
6. **foot_too_close** - 脚距过窄
7. **foot_too_wide** - 脚距过宽
8. **elbow_not_bent** - 肘部弯曲不足

---

## 🔍 技术细节

### 抽帧数量说明

系统默认使用**12帧**，这是基于以下考虑：

- **覆盖完整动作**: 起势动作通常持续3-5秒，12帧能充分覆盖
- **时序信息**: 足够捕捉动作的连续性和演变
- **计算效率**: 在准确性和计算成本间取得平衡
- **训练稳定性**: 264维特征（12×22）适合当前网络规模

如需调整帧数：
1. 修改 `extract_standard_features.py` 中的 `n_frames=12`
2. 重新生成数据和训练模型
3. 确保预测时使用相同帧数

### 边界检测原理

系统通过分析关键特征的变化来检测动作边界：

**开始帧检测**:
- 手臂高度开始持续上升（变化率 > 0.01）
- 当前手臂高度较低（< 0.6）

**结束帧检测**:
- 膝盖弯曲达到峰值
- 脚距变化趋于稳定（变化率 < 0.015）

---

## 🐛 常见问题

### Q: 模型评估结果不准确怎么办？

A: 检查以下几点：
1. 确保使用的是 `taichi_mlp_v2.h5` 模型
2. 确保 `scaler.pkl` 在 taichi_ai 目录下
3. 视频质量要清晰，人物完整可见
4. 重新提取标准视频特征并训练

### Q: 边界检测不准确怎么办？

A: 调整 `frame_selector_v2.py` 中的检测参数：
- 修改手臂上升阈值（默认0.01）
- 修改脚距稳定阈值（默认0.015）
- 修改最小动作时长（默认20帧）

### Q: 想使用不同数量的帧怎么办？

A: 完整流程：
```bash
# 修改 extract_standard_features.py 中的 n_frames
python extract_standard_features.py

# 重新生成数据
python taichi_ai/generate_data_v2.py

# 重新训练
python taichi_ai/train_model_v2.py

# 测试时指定相同帧数
python test_improved_system.py -v video.mp4 -n 你的帧数
```

---

## 📞 技术支持

如有问题，请检查：
1. `系统改进总结_v2.md` - 详细的改进说明
2. 代码中的注释 - 每个函数都有详细文档
3. 训练报告 - `model_evaluation_report_v2.png`

---

**祝使用愉快！** 🎯

