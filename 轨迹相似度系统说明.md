# 轨迹相似度判断系统

## 系统改进概述

将原先基于"单帧差异"的判断方法改为基于"关键点运动轨迹相似度"的判断方法。

## 核心改变

### 旧系统
- 比较单个帧的关键点位置差异
- 判断标准：绝对位置差异

### 新系统
- 追踪关键点在4帧中的运动轨迹
- 判断标准：轨迹形状相似度（归一化后比较）
- 使用DTW（动态时间规整）算法计算轨迹相似度

## 系统架构

### 1. 标准数据提取 (`extract_standard.py`)
- 从4张标准图片（01.png-04.png）提取关键点
- 关键点包括：肩部、肘部、手部、胯部、膝盖部、脚部（左右共12个点）
- 保存为标准轨迹数据

### 2. 轨迹匹配器 (`trajectory_matcher.py`)
- **轨迹归一化**：消除不同体型和位置的影响
  - 计算轨迹中心
  - 归一化到相同尺度
- **DTW相似度计算**：计算标准轨迹与用户轨迹的相似度
- **详细建议生成**：根据各部位相似度生成针对性建议

### 3. 数据生成 (`generate_data.py`)
- 基于标准轨迹生成1000条合成训练数据
- 通过添加不同程度噪声模拟不同质量的动作
- 数据分为训练集（800）和测试集（200）

### 4. 模型训练 (`train_model.py`)
- 随机森林回归模型
- 输入：4帧×12个关键点×2维坐标 = 96维特征
- 输出：动作质量评分（0-1）
- 模型性能：R² = 0.84，MSE = 0.0041

### 5. 轨迹评估器 (`trajectory_evaluator.py`)
- 从视频帧提取关键点
- 调用轨迹匹配器计算相似度
- 生成综合评分、各部位相似度、改进建议

### 6. 主程序 (`main_trajectory.py`)
- 读取视频
- 智能选取4个关键帧
- 评估动作质量
- 输出详细报告

## 核心算法

### DTW（动态时间规整）
```python
distance, _ = fastdtw(standard_trajectory, user_trajectory, dist=euclidean)
similarity = max(0, 100 - distance * 20)
```

### 轨迹归一化
```python
# 中心化
points = points - center
# 尺度归一化
points = points / max_distance
```

## 评分机制

1. **各部位相似度**：0-100分
2. **整体评分**：所有部位平均值
3. **准确度**：整体评分/100

## 建议生成逻辑

- 单个部位相似度<70：该部位需调整
- 上肢整体相似度<75：上肢运动轨迹需调整
- 下肢整体相似度<75：下肢运动轨迹需调整
- 左右差异>10：动作不对称

## 使用方法

```bash
python main_trajectory.py --video video/qishi1.mp4 --output result
```

## 输出示例

```
整体评分: 85.32
准确度: 85.32%

各部位相似度:
  left_shoulder: 87.45
  right_shoulder: 88.21
  left_elbow: 82.33
  right_elbow: 83.67
  ...

建议:
  - left_elbow轨迹偏差较大
  - 注意手臂抬起的弧度和高度
```

## 优势

1. **适应性强**：自动归一化，适应不同体型和位置
2. **更准确**：考虑运动过程，不只是单帧
3. **详细反馈**：针对具体部位给出改进建议
4. **鲁棒性好**：DTW算法对时间轴轻微偏移不敏感

## 文件结构

```
trajectory_system/
├── extract_standard.py          # 提取标准轨迹
├── trajectory_matcher.py        # 轨迹匹配核心
├── generate_data.py            # 生成训练数据
├── train_model.py              # 训练模型
├── trajectory_evaluator.py     # 评估器
├── standard_trajectory.pkl     # 标准轨迹数据
├── training_data.pkl           # 训练数据
└── trajectory_model.pkl        # 训练好的模型

main_trajectory.py              # 新主程序
requirements_trajectory.txt     # 依赖包
```

